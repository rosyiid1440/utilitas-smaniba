<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <h1 class="text-3xl font-semibold text-gray-800">Manajemen Pengguna</h1>
    <div class="flex-shrink-0 flex space-x-2">
        <a href="/users/export/csv?filter_username=<%= currentFilters.filter_username || '' %>&filter_groupname=<%= currentFilters.filter_groupname || '' %>"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            target="_blank">
            <i class="bi bi-download mr-1"></i> Ekspor CSV
        </a>
        <a href="/users/import"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="bi bi-upload mr-1"></i> Impor CSV
        </a>
        <a href="/users/add"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <i class="bi bi-plus-lg mr-1"></i> Tambah Pengguna
        </a>
    </div>
</div>

<% if (message) { %>
    <div class="mt-6 p-4 rounded-lg <%= message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>"
        role="alert">
        <%= message.text %>
    </div>
    <% } %>

        <div class="mt-6 p-4 bg-white rounded-lg shadow-md">
            <form action="/users" method="GET">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div class="w-full">
                        <label for="filter_username" class="text-sm font-medium text-gray-600">Username Wi-Fi
                            (NIS)</label>
                        <input type="text" id="filter_username" name="filter_username" placeholder="Cari NIS..."
                            value="<%= currentFilters.filter_username || '' %>"
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="w-full">
                        <label for="filter_groupname" class="text-sm font-medium text-gray-600">Profil / Grup</label>
                        <select id="filter_groupname" name="filter_groupname"
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">-- Semua Profil --</option>
                            <% if (profiles && profiles.length> 0) { %>
                                <% profiles.forEach(profile=> { %>
                                    <option value="<%= profile.groupname %>"
                                        <%=currentFilters.filter_groupname===profile.groupname ? 'selected' : '' %>><%=
                                            profile.groupname %>
                                    </option>
                                    <% }) %>
                                        <% } %>
                        </select>
                    </div>
                    <div class="w-full lg:col-span-2 flex space-x-2 items-center pt-5">
                        <button type="submit"
                            class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Cari</button>
                        <a href="/users"
                            class="w-full text-center px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Reset</a>
                        <% if (isShowingAll) { %>
                            <a href="?filter_username=<%= currentFilters.filter_username || '' %>&filter_groupname=<%= currentFilters.filter_groupname || '' %>"
                                class="w-full text-center px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700">Tampilkan
                                per Halaman</a>
                            <% } else { %>
                                <a href="?show=all&filter_username=<%= currentFilters.filter_username || '' %>&filter_groupname=<%= currentFilters.filter_groupname || '' %>"
                                    class="w-full text-center px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700">Tampilkan
                                    Semua</a>
                                <% } %>
                    </div>
                </div>
            </form>
        </div>

        <div class="mt-6 bg-white rounded-lg shadow overflow-hidden">
            <form action="/users/batch-action" method="POST" id="batch-form">
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex flex-col sm:flex-row gap-4 items-center">
                    <select name="action" id="batch-action-select"
                        class="w-full sm:w-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm"
                        required>
                        <option value="" disabled selected>-- Pilih Aksi Massal --</option>
                        <option value="change_profile">Ubah Profil Terpilih</option>
                        <option value="delete_selected">Hapus Pengguna Terpilih</option>
                        <option value="delete_by_group">Hapus Semua di Profil</option>
                    </select>
                    <select name="target_profile" id="target-profile-select"
                        class="w-full sm:w-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm hidden">
                        <option value="">-- Pilih Profil Tujuan --</option>
                        <% if (profiles && profiles.length> 0) { %>
                            <% profiles.forEach(profile=> { %>
                                <option value="<%= profile.groupname %>">
                                    <%= profile.groupname %>
                                </option>
                                <% }) %>
                                    <% } %>
                    </select>
                    <button type="submit"
                        class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-gray-800 rounded-lg hover:bg-gray-900">Terapkan</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full whitespace-nowrap">
                        <thead class="bg-gray-50">
                            <tr class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <th class="p-4"><input type="checkbox" id="select-all-checkbox"
                                        class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></th>
                                <th class="p-4">NISN (Login Web)</th>
                                <th class="p-4">Username Wi-Fi (NIS)</th>
                                <th class="p-4">Password Wi-Fi</th>
                                <th class="p-4">Profil / Grup</th>
                                <th class="p-4">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <% if (users.length> 0) { %>
                                <% users.forEach(user=> { %>
                                    <tr class="text-gray-700 hover:bg-gray-50">
                                        <td class="p-4"><input type="checkbox" name="selected_users[]"
                                                value="<%= user.username %>"
                                                class="user-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        </td>
                                        <td class="p-4 text-sm">
                                            <%= user.nisn || '-' %>
                                        </td>
                                        <td class="p-4 text-sm font-medium text-gray-900">
                                            <%= user.username %>
                                        </td>
                                        <td class="p-4 text-sm"><code
                                                class="px-2 py-1 bg-gray-200 rounded text-gray-800"><%= user.password %></code>
                                        </td>
                                        <td class="p-4 text-sm"><span
                                                class="px-2 py-1 font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full">
                                                <%= user.groupname || '-' %>
                                            </span></td>
                                        <td class="p-4 text-sm"><a href="/users/edit/<%= user.username %>"
                                                class="text-blue-600 hover:text-blue-800 hover:underline">Edit</a></td>
                                    </tr>
                                    <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="6" class="p-6 text-center text-gray-500">Tidak ada data
                                                    pengguna yang cocok dengan filter Anda.</td>
                                            </tr>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
            </form>
        </div>

        <% if (totalPages> 1 && !isShowingAll) { %>
            <nav class="flex justify-center mt-6" aria-label="Pagination">
                <% const window=2; // Jumlah halaman yang ditampilkan di sekitar halaman aktif const
                    baseQuery=`&filter_username=${currentFilters.filter_username || ''
                    }&filter_groupname=${currentFilters.filter_groupname || '' }`; %>

                    <a href="?page=<%= currentPage - 1 %><%= baseQuery %>"
                        class="px-3 py-2 mx-1 rounded-md text-sm font-medium <%= currentPage === 1 ? 'text-gray-400 bg-gray-200 pointer-events-none' : 'text-gray-700 bg-white hover:bg-gray-50' %>">
                        &laquo;
                    </a>

                    <% let lastRenderedPage=0; for(let i=1; i <=totalPages; i++) { const shouldRender=(i===1) ||
                        (i===totalPages) || (i>= currentPage -
                        window && i <= currentPage + window); if (shouldRender) { if (i> lastRenderedPage + 1) { %>
                            <span
                                class="px-3 py-2 mx-1 rounded-md text-sm font-medium text-gray-500 bg-white">...</span>
                            <% } %>

                                <a href="?page=<%= i %><%= baseQuery %>"
                                    class="px-3 py-2 mx-1 rounded-md text-sm font-medium <%= i === currentPage ? 'text-white bg-blue-600 z-10' : 'text-gray-700 bg-white hover:bg-gray-50' %>">
                                    <%= i %>
                                </a>
                                <% lastRenderedPage=i; } } %>

                                    <a href="?page=<%= currentPage + 1 %><%= baseQuery %>"
                                        class="px-3 py-2 mx-1 rounded-md text-sm font-medium <%= currentPage === totalPages ? 'text-gray-400 bg-gray-200 pointer-events-none' : 'text-gray-700 bg-white hover:bg-gray-50' %>">
                                        &raquo;
                                    </a>
            </nav>
            <% } %>

                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const actionSelect = document.getElementById('batch-action-select');
                        const profileSelect = document.getElementById('target-profile-select');
                        const batchForm = document.getElementById('batch-form');
                        const selectAllCheckbox = document.getElementById('select-all-checkbox');
                        const userCheckboxes = document.querySelectorAll('.user-checkbox');

                        // Tampilkan/sembunyikan dropdown profil berdasarkan aksi yang dipilih
                        actionSelect.addEventListener('change', () => {
                            if (actionSelect.value === 'change_profile' || actionSelect.value === 'delete_by_group') {
                                profileSelect.classList.remove('hidden');
                                profileSelect.required = true;
                            } else {
                                profileSelect.classList.add('hidden');
                                profileSelect.required = false;
                            }
                        });

                        // Konfirmasi sebelum submit
                        batchForm.addEventListener('submit', (e) => {
                            const selectedAction = actionSelect.options[actionSelect.selectedIndex].text;
                            const selectedUsers = document.querySelectorAll('.user-checkbox:checked').length;

                            if ((actionSelect.value === 'change_profile' || actionSelect.value === 'delete_selected') && selectedUsers === 0) {
                                alert('Anda harus memilih setidaknya satu pengguna untuk aksi ini.');
                                e.preventDefault();
                                return;
                            }

                            if (!confirm(`Apakah Anda yakin ingin melakukan aksi "${selectedAction}"? Aksi ini tidak dapat dibatalkan.`)) {
                                e.preventDefault();
                            }
                        });

                        // Fungsi untuk checkbox "Pilih Semua"
                        selectAllCheckbox.addEventListener('change', () => {
                            userCheckboxes.forEach(checkbox => {
                                checkbox.checked = selectAllCheckbox.checked;
                            });
                        });
                    });
                </script>